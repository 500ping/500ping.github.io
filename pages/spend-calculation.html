<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <title>Trip Members Table Generator</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <style>
            .vnd-input {
                text-align: right;
            }
            .readonly-cell {
                background: #f8f9fa;
            }
            .delete-row-btn {
                color: #fff;
                background: #dc3545;
                border: none;
                padding: 4px 12px;
                border-radius: 4px;
            }
            .delete-row-btn:hover {
                background: #b52a37;
            }
            .summary-row {
                font-weight: bold;
                background: #e2f0d9;
            }
            .realpay-row {
                font-weight: bold;
                background: #fff3cd;
            }
        </style>
    </head>
    <body>
        <div class="container mt-5">
            <h3 class="mb-4">Nhập danh sách thành viên chuyến đi</h3>
            <div class="mb-3">
                <label for="members" class="form-label"
                    >Nhập tên các thành viên, cách nhau bằng dấu phẩy (ví dụ:
                    Thang,Nam,Tung,Cuong):</label
                >
                <textarea
                    class="form-control"
                    id="members"
                    rows="2"
                    placeholder="Thang,Nam,Tung,Cuong"
                ></textarea>
            </div>
            <button id="generateTable" class="btn btn-primary mb-4">
                Generate
            </button>
            <div id="tableContainer"></div>
        </div>

        <script>
            let members = [];

            function formatVND(number) {
                if (!number) return "";
                return Number(number).toLocaleString("vi-VN") + " ₫";
            }

            function createRow(members) {
                let row = "<tr>";
                row += `<td><input type="text" class="form-control" placeholder="Hạng mục"></td>`;
                row += `<td><input type="number" min="0" class="form-control vnd-input" placeholder="0"></td>`;
                row += `<td><select class="form-select">`;
                members.forEach(
                    (m) => (row += `<option value="${m}">${m}</option>`)
                );
                row += `</select></td>`;
                members.forEach((m, idx) => {
                    row += `<td class="text-center"><input type="checkbox" class="form-check-input member-check" data-idx="${idx}" checked></td>`;
                });
                row += `<td class="readonly-cell text-end"><input type="text" class="form-control-plaintext text-end" readonly value=""></td>`;
                row += `<td class="text-center"><button type="button" class="delete-row-btn">Xóa</button></td>`;
                row += "</tr>";
                return row;
            }

            function createSummaryRow(members) {
                let row = '<tr class="summary-row">';
                row += `<td class="text-center">Tổng cộng</td>`;
                row += `<td class="text-end" id="sum-amount"></td>`;
                row += `<td></td>`;
                members.forEach((m, idx) => {
                    row += `<td class="text-end member-sum" data-idx="${idx}"></td>`;
                });
                row += `<td></td><td></td>`;
                row += "</tr>";
                return row;
            }

            function createRealPayRow(members) {
                let row = '<tr class="realpay-row">';
                row += `<td class="text-center">Thực chi</td>`;
                row += `<td></td><td></td>`;
                members.forEach((m, idx) => {
                    row += `<td class="text-end member-realpay" data-idx="${idx}"></td>`;
                });
                row += `<td></td><td></td>`;
                row += "</tr>";
                return row;
            }

            function recalculateRow($row, membersCount) {
                let amount = parseFloat($row.find(".vnd-input").val()) || 0;
                let checked = $row.find(".member-check:checked").length;
                let avg = checked > 0 ? amount / checked : 0;
                let display = avg > 0 ? formatVND(avg.toFixed(0)) : "";
                $row.find("td").eq(-2).find("input").val(display); // Trung Bình Mỗi Người is second last td
            }

            function recalculateSummaryAndRealPay(members) {
                let totalAmount = 0;
                let memberTotals = Array(members.length).fill(0);
                let memberRealPays = Array(members.length).fill(0);

                $("#tripTable tbody tr")
                    .not(".summary-row,.realpay-row")
                    .each(function () {
                        let $row = $(this);
                        let amount =
                            parseFloat($row.find(".vnd-input").val()) || 0;
                        totalAmount += amount;

                        // Trung Bình Mỗi Người (giá trị số, không định dạng)
                        let checked = $row.find(".member-check:checked").length;
                        let avg = checked > 0 ? amount / checked : 0;

                        // Người trả
                        let payer = $row.find("select").val();

                        $row.find(".member-check").each(function (idx) {
                            if ($(this).is(":checked")) {
                                memberTotals[idx] += avg;
                                // Only add to realpay if this member is NOT the payer
                                if (members[idx] !== payer) {
                                    memberRealPays[idx] += avg;
                                }
                            }
                        });
                    });

                $("#sum-amount").text(formatVND(totalAmount.toFixed(0)));
                $(".member-sum").each(function (idx) {
                    $(this).text(
                        memberTotals[idx] > 0
                            ? formatVND(memberTotals[idx].toFixed(0))
                            : ""
                    );
                });
                $(".member-realpay").each(function (idx) {
                    $(this).text(
                        memberRealPays[idx] > 0
                            ? formatVND(memberRealPays[idx].toFixed(0))
                            : ""
                    );
                });
            }

            $(document).ready(function () {
                $("#generateTable").click(function () {
                    members = $("#members")
                        .val()
                        .split(",")
                        .map((m) => m.trim())
                        .filter((m) => m !== "");
                    if (members.length === 0) {
                        $("#tableContainer").html(
                            '<div class="alert alert-warning">Vui lòng nhập ít nhất một thành viên.</div>'
                        );
                        return;
                    }

                    let fixedHeaders = [
                        "Hạng mục ăn chơi",
                        "Số tiền cho hạng mục",
                        "Người trả",
                    ];
                    let headers = fixedHeaders
                        .concat(members)
                        .concat(["Trung Bình Mỗi Người", ""]);

                    let thead = '<thead class="table-dark"><tr>';
                    headers.forEach((h, idx) => {
                        if (idx === headers.length - 1) {
                            thead += `<th class="text-center" style="width:60px;"></th>`;
                        } else {
                            thead += `<th class="text-center">${h}</th>`;
                        }
                    });
                    thead += "</tr></thead>";

                    let tbody = "<tbody></tbody>";

                    let tableHtml = `
            <div class="mb-3">
                <button id="addRow" class="btn btn-success mb-2">Thêm dòng mới</button>
            </div>
            <table class="table table-bordered align-middle" id="tripTable">
                ${thead}
                ${tbody}
            </table>
        `;
                    $("#tableContainer").html(tableHtml);

                    // Add first row automatically
                    $("#addRow").click();

                    // Add event for adding new row
                    $("#addRow")
                        .off("click")
                        .on("click", function () {
                            let $tbody = $("#tripTable tbody");
                            // Remove summary & realpay rows before adding new row
                            $tbody.find(".summary-row,.realpay-row").remove();
                            $tbody.append(createRow(members));
                            // Add summary & realpay rows again
                            $tbody.append(createSummaryRow(members));
                            $tbody.append(createRealPayRow(members));
                            recalculateSummaryAndRealPay(members);
                        });

                    // Add summary & realpay rows after first row
                    let $tbody = $("#tripTable tbody");
                    $tbody.append(createSummaryRow(members));
                    $tbody.append(createRealPayRow(members));

                    // Delegate events for new rows
                    $("#tripTable tbody")
                        .off()
                        .on(
                            "input change",
                            ".vnd-input, .member-check, select",
                            function () {
                                let $row = $(this).closest("tr");
                                recalculateRow($row, members.length);
                                recalculateSummaryAndRealPay(members);
                            }
                        )
                        .on("click", ".delete-row-btn", function () {
                            let $tbody = $("#tripTable tbody");
                            // Remove summary & realpay rows before removing row
                            $tbody.find(".summary-row,.realpay-row").remove();
                            $(this).closest("tr").remove();
                            // Add summary & realpay rows again
                            $tbody.append(createSummaryRow(members));
                            $tbody.append(createRealPayRow(members));
                            recalculateSummaryAndRealPay(members);
                        });

                    // Trigger calculation for the first row
                    setTimeout(function () {
                        $("#tripTable tbody tr").each(function () {
                            recalculateRow($(this), members.length);
                        });
                        recalculateSummaryAndRealPay(members);
                    }, 100);
                });
            });
        </script>
    </body>
</html>
